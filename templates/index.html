<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½æ–‡æ¡£é—®ç­”</title>
    <script src="https://unpkg.com/htmx.org@1.9.9"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
    <div class="container">
        <h2>pdfæ–‡æ¡£RAGé—®ç­”ç³»ç»Ÿ</h2>
        <div class="mt-4">
            <h4>ä¸Šä¼  PDF æ–‡æ¡£</h4>
        
            <!-- ä¸Šä¼  PDF -->
            <input type="file" id="pdfFile" accept=".pdf" class="form-control mb-2">
            <button class="btn btn-success" onclick="uploadPdf()">ä¸Šä¼ </button>
        
            <!-- æ˜¾ç¤ºä¸Šä¼ ç»“æœå’Œ pdf_path -->
            <div id="uploadStatus" class="mt-2 text-secondary"></div>
        
            <!-- åµŒå…¥æŒ‰é’® -->
            <button class="btn btn-primary mt-2 d-none" id="embedButton" onclick="startEmbedding()">å¼€å§‹åµŒå…¥</button>
        
            <!-- åµŒå…¥è¿‡ç¨‹æç¤º -->
            <div id="embedStatus" class="mt-2 text-secondary"></div>
        </div>
        
        <script>
        let uploadedPdfPath = "";
        
        function uploadPdf() {
            const fileInput = document.getElementById("pdfFile");
            if (fileInput.files.length === 0) {
                alert("è¯·é€‰æ‹© PDF æ–‡ä»¶ï¼");
                return;
            }
        
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
        
            document.getElementById("uploadStatus").innerText = "â³ æ­£åœ¨ä¸Šä¼ ...";
            document.getElementById("embedStatus").innerText = "";
            document.getElementById("embedButton").classList.add("d-none");
        
            fetch("/upload", { method: "POST", body: formData })
                .then(response => response.json())
                .then(result => {
                    if (result.status === "success") {
                        uploadedPdfPath = result.pdf_path;
                        document.getElementById("uploadStatus").innerText = "âœ… ä¸Šä¼ æˆåŠŸï¼š" + uploadedPdfPath;
                        document.getElementById("embedButton").classList.remove("d-none");
                    } else {
                        document.getElementById("uploadStatus").innerText = "âŒ ä¸Šä¼ å¤±è´¥ï¼š" + result.message;
                    }
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById("uploadStatus").innerText = "âŒ ä¸Šä¼ å‡ºé”™";
                });
        }
        
        function startEmbedding() {
            if (!uploadedPdfPath) {
                alert("è¯·å…ˆä¸Šä¼  PDF");
                return;
            }
        
            document.getElementById("embedStatus").innerText = "â³ æ­£åœ¨åµŒå…¥ï¼Œè¯·ç¨å€™...";
            document.getElementById("embedButton").disabled = true;
        
            fetch("/embed", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ pdf_path: uploadedPdfPath })
            })
            .then(response => response.json())
            .then(result => {
                if (result.status === "success") {
                    document.getElementById("embedStatus").innerText = "âœ… åµŒå…¥å®Œæˆï¼š" + result.message;
                } else {
                    document.getElementById("embedStatus").innerText = "âŒ åµŒå…¥å¤±è´¥ï¼š" + result.message;
                }
                document.getElementById("embedButton").disabled = false;
            })
            .catch(error => {
                console.error(error);
                document.getElementById("embedStatus").innerText = "âŒ åµŒå…¥å‡ºé”™";
                document.getElementById("embedButton").disabled = false;
            });
        }
        </script>

        <div class="mb-3">
            <input type="text" class="form-control" name="query" id="query" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜">
        </div>

        <div class="d-flex align-items-center">
            <button class="btn btn-primary me-3"
                id="send-btn"
                hx-post="/ask"
                hx-target="#chat"
                hx-include="#query"
                hx-swap="beforeend">
                å‘é€
            </button>
            <span id="loading" style="display:none; color: #555;">ğŸ¤– æ­£åœ¨ç”Ÿæˆå›ç­”...</span>
        </div>

        <div id="chat" class="mt-4 border p-3 rounded" style="background:#f8f9fa; min-height: 300px;">
            <p class="text-muted">å¯¹è¯è®°å½•ï¼š</p>
        </div>
    </div>

    <script>
    document.body.addEventListener("htmx:beforeRequest", () => {
        document.getElementById("loading").style.display = "inline";
        document.getElementById("send-btn").disabled = true;
    });

    document.body.addEventListener("htmx:afterRequest", () => {
        document.getElementById("loading").style.display = "none";
        document.getElementById("send-btn").disabled = false;
    });
    </script>
</body>
</html>